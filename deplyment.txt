To connect **Nginx, FastAPI, Database (MySQL/PostgreSQL), Models, and Schemas** together in a **production-ready setup**, follow these steps:

---

# **ğŸ“Œ Step-by-Step Deployment of a Complete FastAPI Project on AWS EC2 Using Nginx**
âœ… **What We Will Cover:**  
1ï¸âƒ£ **FastAPI Project Structure**  
2ï¸âƒ£ **Database Connection (MySQL/PostgreSQL)**  
3ï¸âƒ£ **Models & Schemas**  
4ï¸âƒ£ **FastAPI API Endpoints**  
5ï¸âƒ£ **Configuring Uvicorn & Gunicorn**  
6ï¸âƒ£ **Setting Up Nginx as a Reverse Proxy**  
7ï¸âƒ£ **Connecting Everything for Deployment**  

---

## **1ï¸âƒ£ FastAPI Project Structure**
Before deploying, let's define a **clean project structure**:

```
/home/ubuntu/myproject/
â”‚â”€â”€ app/
â”‚   â”œâ”€â”€ main.py              # FastAPI entry point
â”‚   â”œâ”€â”€ database.py          # Database connection
â”‚   â”œâ”€â”€ models.py            # SQLAlchemy models
â”‚   â”œâ”€â”€ schemas.py           # Pydantic schemas
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ users.py         # User routes
â”‚   â”‚   â”œâ”€â”€ products.py      # Product routes
â”‚   â”œâ”€â”€ static/              # Static files (CSS, JS, images)
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â”œâ”€â”€ styles/
â”‚   â”‚   â”œâ”€â”€ scripts/
â”‚â”€â”€ nginx.conf               # Nginx configuration
â”‚â”€â”€ gunicorn_conf.py         # Gunicorn configuration
â”‚â”€â”€ requirements.txt         # Python dependencies
â”‚â”€â”€ .env                     # Environment variables
```

---

## **2ï¸âƒ£ Database Connection (`database.py`)**
First, **connect FastAPI to a database** (MySQL or PostgreSQL).

ğŸ“Œ **Create `database.py`:**
```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
import os

# Load environment variables
DB_USER = os.getenv("DB_USER", "root")
DB_PASS = os.getenv("DB_PASS", "password")
DB_HOST = os.getenv("DB_HOST", "localhost")
DB_NAME = os.getenv("DB_NAME", "mydatabase")

DATABASE_URL = f"mysql+pymysql://{DB_USER}:{DB_PASS}@{DB_HOST}/{DB_NAME}"

# Create SQLAlchemy engine
engine = create_engine(DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()

# Dependency to get DB session
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

âœ… **Now, FastAPI is connected to MySQL/PostgreSQL.**

---

## **3ï¸âƒ£ Models (`models.py`)**
ğŸ“Œ **Define a User Model in `models.py`:**
```python
from sqlalchemy import Column, Integer, String
from .database import Base

class User(Base):
    __tablename__ = "users"

    id = Column(Integer, primary_key=True, index=True)
    name = Column(String(50), nullable=False)
    email = Column(String(100), unique=True, index=True, nullable=False)
    password = Column(String(255), nullable=False)
```

âœ… **This defines a `users` table with `id, name, email, password`.**

---

## **4ï¸âƒ£ Pydantic Schemas (`schemas.py`)**
ğŸ“Œ **Create `schemas.py` to validate API requests:**
```python
from pydantic import BaseModel, EmailStr

class UserCreate(BaseModel):
    name: str
    email: EmailStr
    password: str

class UserResponse(BaseModel):
    id: int
    name: str
    email: str

    class Config:
        from_attributes = True
```

âœ… **This ensures proper validation when sending data to API endpoints.**

---

## **5ï¸âƒ£ Create API Endpoints (`routes/users.py`)**
ğŸ“Œ **Create `users.py` inside `routes/`:**
```python
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from ..database import get_db
from ..models import User
from ..schemas import UserCreate, UserResponse
from passlib.context import CryptContext

router = APIRouter()

pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

@router.post("/register", response_model=UserResponse)
def register_user(user: UserCreate, db: Session = Depends(get_db)):
    hashed_password = pwd_context.hash(user.password)
    new_user = User(name=user.name, email=user.email, password=hashed_password)
    db.add(new_user)
    db.commit()
    db.refresh(new_user)
    return new_user

@router.get("/users/{user_id}", response_model=UserResponse)
def get_user(user_id: int, db: Session = Depends(get_db)):
    user = db.query(User).filter(User.id == user_id).first()
    if not user:
        raise HTTPException(status_code=404, detail="User not found")
    return user
```

âœ… **Now, FastAPI has:**
- **`/register`** â†’ Create a user  
- **`/users/{id}`** â†’ Get user details  

---

## **6ï¸âƒ£ Main FastAPI Entry (`main.py`)**
ğŸ“Œ **Create `main.py`:**
```python
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from .routes import users

app = FastAPI()

# Mount static files
app.mount("/static", StaticFiles(directory="static"), name="static")

# Include routes
app.include_router(users.router)

@app.get("/")
def root():
    return {"message": "FastAPI + Nginx Deployment Working!"}
```

âœ… **This initializes FastAPI and mounts `users.py` routes.**

---

## **7ï¸âƒ£ Configure Gunicorn (`gunicorn_conf.py`)**
ğŸ“Œ **Create `gunicorn_conf.py`:**
```python
workers = 4
bind = "0.0.0.0:8000"
worker_class = "uvicorn.workers.UvicornWorker"
```
âœ… **Gunicorn will run FastAPI with 4 workers.**

---

## **8ï¸âƒ£ Set Up Nginx Configuration (`nginx.conf`)**
ğŸ“Œ **Create `/etc/nginx/sites-available/fastapi`:**
```nginx
server {
    listen 80;
    server_name your-ec2-public-ip;

    location /static/ {
        alias /home/ubuntu/myproject/app/static/;
        autoindex on;
    }

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### **Enable Nginx Configuration:**
```bash
sudo ln -s /etc/nginx/sites-available/fastapi /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

âœ… **Now, Nginx serves FastAPI & static files.**

---

## **9ï¸âƒ£ Run FastAPI in the Background**
### **Using Gunicorn + Uvicorn**
```bash
gunicorn -c gunicorn_conf.py app.main:app
```

âœ… **FastAPI is now running on `http://your-ec2-public-ip/`.**

---

## **ğŸ”Ÿ Final Testing**
ğŸ“Œ Open your browser & test your FastAPI APIs:

ğŸ”¹ **Check API Root:**
```
http://your-ec2-public-ip/
```

ğŸ”¹ **Register a User (POST Request):**
```
http://your-ec2-public-ip/register
```
Request Body:
```json
{
    "name": "John Doe",
    "email": "john@example.com",
    "password": "securepassword"
}
```

ğŸ”¹ **Fetch User Details:**
```
http://your-ec2-public-ip/users/1
```

ğŸ”¹ **Static File Access:**
```
http://your-ec2-public-ip/static/images/logo.png
```

---

## **âœ… Summary**
ğŸš€ **Now, everything is deployed & working:**
âœ” **FastAPI** (Backend API)  
âœ” **MySQL/PostgreSQL** (Database)  
âœ” **Nginx** (Reverse Proxy)  
âœ” **Gunicorn** (Process Manager)  
âœ” **Static File Hosting**  

Let me know if you have any issues! ğŸ˜ŠğŸš€